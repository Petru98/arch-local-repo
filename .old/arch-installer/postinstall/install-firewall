install_firewall() {
    print_title "Firewall - https://wiki.archlinux.org/index.php/Uncomplicated_Firewall"
    print_info "Installing ufw."
    package_install gufw ufw-extras

    print_title "iptables - https://wiki.archlinux.org/index.php/Iptables"
    print_info "Creating no-internet group."
    add_user_to_group $USERNAME no-internet

    print_info "Adding custom rules to ufw."
    local gid=$(getent group no-internet | cut -d: -f3)
    local rules

    rules="# group no-internet"
    rules="$rules\\n-A ufw-before-output -m owner --gid-owner $gid -d 127.0.0.0/8 -j ACCEPT"
    rules="$rules\\n-A ufw-before-output -m owner --gid-owner $gid -j REJECT"
    # rules="$rules\\n-A ufw-before-input -m owner --gid-owner $gid -s 127.0.0.0/8 -j ACCEPT"
    # rules="$rules\\n-A ufw-before-input -m owner --gid-owner $gid -j REJECT"
    awk -v "rules=$rules\n" '/^(#.*COMMIT.*)|(COMMIT)/ && !x {print rules; x=1} 1' /etc/ufw/before.rules > /etc/ufw/before.rules.tmp
    mv -f /etc/ufw/before.rules.tmp /etc/ufw/before.rules

    rules="# group no-internet"
    rules="$rules\\n-A ufw6-before-output -m owner --gid-owner $gid -d ::1/128 -j ACCEPT"
    rules="$rules\\n-A ufw6-before-output -m owner --gid-owner $gid -j REJECT"
    # rules="$rules\\n-A ufw6-before-input -m owner --gid-owner $gid -s ::1/128 -j ACCEPT"
    # rules="$rules\\n-A ufw6-before-input -m owner --gid-owner $gid -j REJECT"
    awk -v "rules=$rules\n" '/^(#.*COMMIT.*)|(COMMIT)/ && !x {print rules; x=1} 1' /etc/ufw/before6.rules > /etc/ufw/before6.rules.tmp
    mv -f /etc/ufw/before6.rules.tmp /etc/ufw/before6.rules

    print_info "Enabling firewall."
    systemctl enable ufw.service
    ufw enable
}

install_firewall
